<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flipâ€‘toâ€‘6 â€” Game Table v1.0.1</title>

<style>
/* ============================================================
   GENERAL PAGE STYLE
   ============================================================ */
body {
  font-family: Arial, sans-serif;
  background: #304730;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 0;
}

#status {
  margin: 10px;
  font-weight: bold;
  color: #fff;
}

/* ============================================================
   ACCORDION SECTIONS
   ============================================================ */
details {
  border: 1px solid #ccc;
  border-radius: 6px;
  margin: 6px auto;
  width: 95%;
  background: #222;
}
summary {
  cursor: pointer;
  padding: 5px 0px;
  font-weight: 600;
  list-style: none;
}
summary::before {
  content: "â–¶";
  font-size: 0.9em;
  margin-right: 8px;
  transition: transform 0.2s ease;
  display: inline-block;
}
details[open] summary::before {
  transform: rotate(90deg);
}
details > div {
  padding: 6px 6px;
  border-top: 1px solid #444;
  background: #333;
}

/* ============================================================
   TABLE LAYOUT (6 SEATS)
   ============================================================ */
table.playing-table {
  margin: 5px auto;
  border-collapse: collapse;
  table-layout: fixed;
  width: 1200px;
}
.playing-table td {
  border: 2px solid #444;
  padding: 10px;
  vertical-align: top;
  background: #0a7f4f;
  border-radius: 8px;
}

/* Middle column default: centered vertically */
.playing-table tr td:nth-child(2) {
  background: #7992BA;
  vertical-align: middle;
}

/* Row 3 middle column override: TOP aligned */
.playing-table tr:nth-child(3) td:nth-child(2) {
  vertical-align: top;
}

/* ============================================================
   PLAYER NAME + SCORE
   ============================================================ */
.player-name {
  font-weight: bold;
  margin-bottom: 10px;
  font-size: 1.1em;
}

/* ============================================================
   CARD SLOTS
   ============================================================ */
.card-row {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 5px;
}

.card {
  width: 70px;
  height: 100px;
  background: transparent;
  border: none;
  border-radius: 6px;
  position: relative;
  overflow: hidden;
}

.card img {
  width: 70px;
  height: 100px;
  border-radius: 6px;
  border: 3px solid #000;
}

/* ============================================================
   DECK AREA
   ============================================================ */
.deck {
  position: relative;
  width: 80px;
  height: 110px;
  margin: 40px auto;
  cursor: pointer;
  user-select: none;
}

.deck.disabled {
  pointer-events: none;
  opacity: 0.5;
  cursor: not-allowed;
}

.deck .card {
  position: absolute;
  top: 0;
  left: 0;
}

/* Placeholder deck before first draw */
#deck.placeholder::before {
  content: "Click to Start";
  display: flex;
  align-items: center;
  justify-content: center;
  width: 70px;
  height: 100px;
  border: 2px dashed #fff;
  border-radius: 6px;
  margin: auto;
  color: #fff;
  font-weight: bold;
}

/* ============================================================
   DISCARD AREA
   ============================================================ */
td.discard-cell {
  text-align: center;
  vertical-align: top;
  padding: 10px 0;
}

#discard-pile.empty::before {
  content: "Empty";
  color: #fff;
  font-weight: bold;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 70px;
  height: 100px;
  border: 2px dashed #fff;
  border-radius: 6px;
  margin: auto;
}

/* ============================================================
   BUTTONS
   ============================================================ */
.stay-button {
  background-color: #3f3f4f;
  color: #fff;
  font-size: 1.1em;
  font-weight: bold;
  padding: 22px 22px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.stay-button:hover {
  background-color: #1ff233;
}

.end-turns-button {
  background-color: #6D1AA1;
  color: #fff;
  font-size: 1.1em;
  font-weight: bold;
  padding: 20px 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-bottom: 8px;
}
.end-turns-button:hover {
  background-color: #1ff233;
}
.end-turns-button:disabled {
  background-color: #555 !important;
  color: #999 !important;
  cursor: not-allowed;
  opacity: 0.6;
}

/* ============================================================
   PLAYER HIGHLIGHTING
   ============================================================ */
.active-player {
  outline: 5px solid yellow;
  outline-offset: -5px;
  background-color: #c9b800 !important;
}

.stayed-player {
  outline: 5px solid red;
  outline-offset: -5px;
  background-color: #8b0000 !important;
}

/* ============================================================
   TARGET SELECTION MODE (Option C)
   ============================================================ */
.target-eligible {
  outline: 5px solid #00ffea;
  outline-offset: -5px;
  cursor: pointer;
}
.target-ineligible {
  opacity: 0.3;
}

/* ============================================================
   PAUSE OVERLAY
   ============================================================ */
#pause-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(20, 20, 20, 0.85);
  color: #fff;
  font-size: 2em;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
</style>
</head>

<body>

<!-- ============================================================
     PAUSE OVERLAY
     ============================================================ -->
<div id="pause-overlay">Game Paused â€” Waiting for Playerâ€¦</div>

<!-- ============================================================
     CONTROLS ACCORDION
     ============================================================ -->
<details open>
  <summary>Controls</summary>
  <div>
    <input id="removeName" placeholder="Player name to remove" style="margin-right:8px;">
    <button id="removeBtn">Remove Player</button>
  </div>
</details>

<!-- ============================================================
     PLAYING TABLE ACCORDION
     ============================================================ -->
<details open>
  <summary>Playing Table</summary>
  <div>
    <table class="playing-table">
      <colgroup>
        <col style="width: 45%;">
        <col style="width: 10%;">
        <col style="width: 45%;">
      </colgroup>
      <tbody>

        <!-- ============================================================
             ROW 1 â€” Seats 1 & 2 + Discard
             ============================================================ -->
        <tr>
          <!-- Seat 1 (order_index 0) -->
          <td id="alice-cell">
            <div class="player-name">Seat 1</div>
            <div class="card-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
            <div class="card-row second-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
          </td>

          <!-- Discard pile + End Round -->
          <td class="discard-cell">
            <button id="end-turns" class="end-turns-button" disabled>End Round</button>
            <div id="discard-pile" class="deck empty"></div>
            <div id="discard-count">Discarded: 0</div>
          </td>

          <!-- Seat 2 (order_index 1) -->
          <td id="bob-cell">
            <div class="player-name">Seat 2</div>
            <div class="card-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
            <div class="card-row second-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
          </td>
        </tr>

        <!-- ============================================================
             ROW 2 â€” Seats 3 & 4 + Deck
             ============================================================ -->
        <tr>
          <!-- Seat 3 (order_index 2) -->
          <td id="carol-cell">
            <div class="player-name">Seat 3</div>
            <div class="card-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
            <div class="card-row second-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
          </td>

          <!-- Deck -->
          <td class="deck-cell">
            <div class="player-name deck-label">Deck</div>
            <div class="deck placeholder" id="deck"></div>
            <div id="deck-count">0 cards</div>
          </td>

          <!-- Seat 4 (order_index 3) -->
          <td id="dave-cell">
            <div class="player-name">Seat 4</div>
            <div class="card-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
            <div class="card-row second-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
          </td>
        </tr>

        <!-- ============================================================
             ROW 3 â€” Seats 5 & 6 + Stay Button
             ============================================================ -->
        <tr>
          <!-- Seat 5 (order_index 4) -->
          <td id="eve-cell">
            <div class="player-name">Seat 5</div>
            <div class="card-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
            <div class="card-row second-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
          </td>

          <!-- Stay button -->
          <td class="stay-cell">
            <button id="stay-button" class="stay-button">ðŸª¬ Stay</button>
          </td>

          <!-- Seat 6 (order_index 5) -->
          <td id="frank-cell">
            <div class="player-name">Seat 6</div>
            <div class="card-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
            <div class="card-row second-row">
              <div class="card"></div><div class="card"></div><div class="card"></div>
              <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
            </div>
          </td>
        </tr>

      </tbody>
    </table>
  </div>

  <div id="status"></div>
</details>

<!-- ============================================================
     SCORING ACCORDION
     ============================================================ -->
<details>
  <summary>Scoring</summary>
  <div>
    <p>Scores are tracked server-side per round and total.</p>
  </div>
</details>

<!-- ============================================================
     SOCKET.IO + GAME LOGIC
     ============================================================ -->
<script src="/socket.io/socket.io.js"></script>
<script>
/* ============================================================
   URL PARAMS
   ============================================================ */
const urlParams = new URLSearchParams(window.location.search);
const playerId = parseInt(urlParams.get("playerId"), 10);
const roomCode = window.location.pathname.split("/").pop().toUpperCase();

/* ============================================================
   SOCKET
   ============================================================ */
const socket = io();

/* ============================================================
   DOM ELEMENTS
   ============================================================ */
const statusDiv = document.getElementById("status");
const deckDiv = document.getElementById("deck");
const discardPileDiv = document.getElementById("discard-pile");
const discardCountDiv = document.getElementById("discard-count");
const deckCountDiv = document.getElementById("deck-count");
const stayButton = document.getElementById("stay-button");
const endTurnsButton = document.getElementById("end-turns");
const removeNameInput = document.getElementById("removeName");
const removeBtn = document.getElementById("removeBtn");
const pauseOverlay = document.getElementById("pause-overlay");

/* ============================================================
   SEAT MAPPING (order_index â†’ seat cell)
   ============================================================ */
const seatIds = [
  "alice-cell",
  "bob-cell",
  "carol-cell",
  "dave-cell",
  "eve-cell",
  "frank-cell"
];

/* ============================================================
   CARD METADATA (value â†’ filename)
   ============================================================ */
let cardMeta = {};

async function loadCardMeta() {
  const res = await fetch("/api/cards/meta");
  const data = await res.json();
  if (data.success) {
    data.cards.forEach(c => {
      cardMeta[c.value] = c.filename;
    });
  }
}

function getCardImgSrc(value) {
  const filename = cardMeta[value] || (value + ".png");
  return "cards/" + filename;
}

/* ============================================================
   ROUND SCORE CALC (client-side mirror of server)
   ============================================================ */
function computeRoundScore(values) {
  let score = 0;
  let mult = 1;

  for (const v of values) {
    const num = parseInt(v, 10);
    if (!isNaN(num)) {
      score += num;
      continue;
    }
    if (v === "2x") mult *= 2;
    if (v === "4+") score += 4;
    if (v === "5+") score += 5;
    if (v === "6-") score -= 6;
  }

  return score * mult;
}

/* ============================================================
   RENDER DECK
   ============================================================ */
function renderDeck(state) {
  deckDiv.innerHTML = "";

  // Placeholder deck before first draw
  if (state.topDrawCards.length === 0 && state.deckCount === 0) {
    deckDiv.classList.add("placeholder");
    deckCountDiv.textContent = "0 cards";
    return;
  }

  deckDiv.classList.remove("placeholder");

  const topCards = state.topDrawCards || [];
  const maxShow = Math.min(topCards.length, 5);

  for (let i = 0; i < maxShow; i++) {
    const value = topCards[i];
    const cardEl = document.createElement("div");
    cardEl.classList.add("card");

    const img = document.createElement("img");
    img.src = getCardImgSrc(value);
    cardEl.appendChild(img);

    cardEl.style.top = (i * 4) + "px";
    cardEl.style.left = (i * 4) + "px";

    deckDiv.appendChild(cardEl);
  }

  deckCountDiv.textContent = state.deckCount + " cards";
}

/* ============================================================
   RENDER DISCARD
   ============================================================ */
function renderDiscard(state) {
  discardPileDiv.classList.add("empty");
  discardPileDiv.innerHTML = "";
  discardCountDiv.textContent = "Discarded: " + state.discardCount;
}

/* ============================================================
   RENDER PLAYERS + HANDS
   ============================================================ */
function renderPlayers(state) {
  // Build handsByPlayer: { playerId: [values...] }
  const handsByPlayer = {};
  state.hands.forEach(h => {
    if (!handsByPlayer[h.player_id]) handsByPlayer[h.player_id] = [];
    handsByPlayer[h.player_id].push(h.value);
  });

  // Clear all seats first
  seatIds.forEach(id => {
    const cell = document.getElementById(id);
    const nameDiv = cell.querySelector(".player-name");
    nameDiv.textContent = "Empty Seat";
    cell.classList.remove("active-player", "stayed-player", "target-eligible", "target-ineligible");

    const slots = cell.querySelectorAll(".card-row .card");
    slots.forEach(slot => {
      slot.innerHTML = "";
    });
  });

  // Fill seats in order_index order
  state.players.forEach((p, index) => {
    if (index >= seatIds.length) return;
    const cellId = seatIds[index];
    const cell = document.getElementById(cellId);
    const nameDiv = cell.querySelector(".player-name");

    const handValues = handsByPlayer[p.id] || [];
    const roundScore = computeRoundScore(handValues);
    const totalScore = p.total_score || 0;

    nameDiv.textContent = `${p.name} â€” ${roundScore} / ${totalScore}`;

    // Stayed highlight
    if (p.stayed) cell.classList.add("stayed-player");

    // Active player highlight
    if (state.currentPlayerId === p.id && !p.stayed && p.active && !state.roundOver && !state.paused) {
      cell.classList.add("active-player");
    }

    // Fill card slots with PNGs
    const slots = cell.querySelectorAll(".card-row .card");
    slots.forEach((slot, i) => {
      slot.innerHTML = "";
      if (i < handValues.length) {
        const v = handValues[i];
        const img = document.createElement("img");
        img.src = getCardImgSrc(v);
        slot.appendChild(img);
      }
    });
  });

  // Target selection mode (Option C)
  applyTargetSelection(state);
}

/* ============================================================
   TARGET SELECTION MODE (Option C)
   ============================================================ */
function applyTargetSelection(state) {
  // Clear all target classes first
  seatIds.forEach(id => {
    const cell = document.getElementById(id);
    cell.classList.remove("target-eligible", "target-ineligible");
    cell.onclick = null;
  });

  // If no pending action â†’ nothing to do
  if (!state.pendingActionType) return;

  const actorId = state.pendingActionActorId;
  const action = state.pendingActionType;

  // Determine eligible targets
  state.players.forEach((p, index) => {
    const cellId = seatIds[index];
    const cell = document.getElementById(cellId);

    // Skip empty seats
    if (!p) return;

    let eligible = false;

    if (action === "Freeze") {
      eligible = p.active && !p.stayed && p.id !== actorId;
    }

    if (action === "Swap") {
      eligible = p.active; // self allowed
    }

    if (action === "Take3") {
      eligible = p.active && !p.stayed; // self allowed
    }

    if (action === "SecondChance") {
      // SecondChance is resolved via a popup, not seat clicking
      eligible = false;
    }

    if (eligible) {
      cell.classList.add("target-eligible");
      cell.onclick = () => {
        socket.emit("actionTarget", {
          roomCode,
          playerId: actorId,
          action,
          targetId: p.id
        });
      };
    } else {
      cell.classList.add("target-ineligible");
    }
  });
}

/* ============================================================
   BUTTON ENABLE/DISABLE LOGIC
   ============================================================ */
function updateButtons(state) {
  const isMyTurn = state.currentPlayerId === playerId && !state.roundOver && !state.paused;
  const canDraw = isMyTurn && !state.pendingActionType && state.deckCount > 0;

  deckDiv.classList.toggle("disabled", !canDraw);
  stayButton.disabled = !isMyTurn || state.pendingActionType;
  endTurnsButton.disabled = !state.roundOver || state.paused;

  if (state.paused) {
    statusDiv.textContent = "Game paused â€” waiting for disconnected players.";
    return;
  }

  if (state.roundOver) {
    statusDiv.textContent = "Round over. Click End Round.";
    return;
  }

  if (state.pendingActionType) {
    const actor = state.players.find(p => p.id === state.pendingActionActorId);
    if (actor && actor.id === playerId) {
      statusDiv.textContent = `Choose a target for ${state.pendingActionType}`;
    } else {
      statusDiv.textContent = `${actor ? actor.name : "A player"} is choosing a targetâ€¦`;
    }
    return;
  }

  if (isMyTurn) {
    const me = state.players.find(p => p.id === playerId);
    statusDiv.textContent = `Your turn, ${me ? me.name : "Player"}.`;
  } else {
    const current = state.players.find(p => p.id === state.currentPlayerId);
    statusDiv.textContent = current ? `Current player: ${current.name}` : "Waiting for playersâ€¦";
  }
}

/* ============================================================
   PAUSE OVERLAY
   ============================================================ */
function updatePauseOverlay(state) {
  if (state.paused) {
    const disconnected = state.disconnectedPlayers.map(p => p.name).join(", ");
    pauseOverlay.textContent = `Game Paused â€” Waiting for ${disconnected}`;
    pauseOverlay.style.display = "flex";
  } else {
    pauseOverlay.style.display = "none";
  }
}

/* ============================================================
   SOCKET STATE UPDATE
   ============================================================ */
socket.on("stateUpdate", (state) => {
  renderDeck(state);
  renderDiscard(state);
  renderPlayers(state);
  updateButtons(state);
  updatePauseOverlay(state);
});

/* ============================================================
   ON CONNECT â†’ LOAD CARD META + JOIN ROOM
   ============================================================ */
socket.on("connect", async () => {
  await loadCardMeta();
  socket.emit("joinRoom", { roomCode, playerId });
});

/* ============================================================
   UI EVENTS
   ============================================================ */
deckDiv.addEventListener("click", () => {
  socket.emit("drawCard", { roomCode, playerId });
});

stayButton.addEventListener("click", () => {
  socket.emit("stay", { roomCode, playerId });
});

endTurnsButton.addEventListener("click", () => {
  socket.emit("endRound", { roomCode });
});

removeBtn.addEventListener("click", () => {
  const name = removeNameInput.value.trim();
  if (!name) return;
  socket.emit("removePlayer", { roomCode, name });
  removeNameInput.value = "";
});

/* ============================================================
   INITIAL STATUS
   ============================================================ */
statusDiv.textContent = "Connecting to roomâ€¦";

</script>

</body>
</html>

