<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flip to 6: Playing Table v1</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #304730;
      color: #fff;
      text-align: center;
    }

    /* Accordion styling */
    details {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 6px 0;
      background: #222;
    }
    summary {
      cursor: pointer;
      padding: 5px 0px;
      font-weight: 600;
      list-style: none;
    }
    summary::before {
      content: "â–¶";
      font-size: 0.9em;
      margin-right: 8px;
      transition: transform 0.2s ease;
      display: inline-block;
    }
    details[open] summary::before {
      transform: rotate(90deg);
    }
    details > div {
      padding: 6px 6px;
      border-top: 1px solid #444;
      background: #333;
    }

    /* Table layout */
    table.playing-table {
      margin: 5px auto;
      border-collapse: collapse;
      table-layout: fixed;
      width: 1200px;
    }
    .playing-table td {
      border: 2px solid #444;
      padding: 10px;
      vertical-align: top;
      background: #0a7f4f;
      border-radius: 8px;
    }

    /* Middle column default: centered vertically */
    .playing-table tr td:nth-child(2) {
      background: #7992BA;
      vertical-align: middle;
    }

    /* Row 3 middle column override: TOP aligned */
    .playing-table tr:nth-child(3) td:nth-child(2) {
      vertical-align: top;
    }

    /* Player name */
    .player-name {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    /* Card rows */
    .card-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    /* Individual card slot */
    .card {
      width: 70px;
      height: 100px;
      background: transparent;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: default;
      user-select: none;
      overflow: hidden;
    }

    .card img {
      position: absolute;
      top: 0;
      left: 0;
      width: 70px;
      height: 100px;
      border: 3px solid #000;
      border-radius: 6px;
    }

    /* Deck container */
    .deck {
      position: relative;
      width: 80px;
      height: 110px;
      margin: 40px auto;
      cursor: pointer;
      user-select: none;
    }

    .deck.disabled {
      pointer-events: none;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .deck .card {
      position: absolute;
      top: 0;
      left: 0;
      transition: all 0.2s ease;
      width: 70px;
      height: 100px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Discard cell */
    td.discard-cell {
      text-align: center;
      vertical-align: top;
      padding: 10px 0;
      user-select: none;
    }

    /* Discard pile empty outline */
    #discard-pile.empty::before {
      content: "Empty";
      color: #fff;
      font-weight: bold;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 70px;
      height: 100px;
      border: 2px dashed #fff;
      border-radius: 6px;
      margin: auto;
    }

    /* Stay cell */
    td.stay-cell {
      text-align: center;
      vertical-align: top;
      padding: 10px 0;
    }

    /* Stay button */
    .stay-button {
      background-color: #3f3f4f;
      color: #fff;
      font-size: 1.1em;
      font-weight: bold;
      padding: 22px 22px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .stay-button:hover {
      background-color: #1ff233;
    }

    /* End Round button */
    .end-turns-button {
      background-color: #6D1AA1;
      color: #fff;
      font-size: 1.1em;
      font-weight: bold;
      padding: 20px 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.3s ease;
    }
    .end-turns-button:hover {
      background-color: #1ff233;
    }

    .end-turns-button:disabled {
      background-color: #555 !important;
      color: #999 !important;
      cursor: not-allowed;
      opacity: 0.6;
      border: 2px solid #333;
    }
    .end-turns-button:disabled:hover {
      background-color: #555 !important;
    }

    /* Highlight the active player's cell */
    .active-player {
      outline: 5px solid yellow;
      outline-offset: -5px;
      background-color: #c9b800 !important;
      transition: background-color 0.3s ease, outline 0.3s ease;
    }

    /* Player who has chosen Stay */
    .stayed-player {
      outline: 5px solid red;
      outline-offset: -5px;
      background-color: #8b0000 !important;
    }

    #status {
      margin:10px;
      font-weight:bold;
      color:#fff;
    }
  </style>
</head>
<body>

  <!-- Controls accordion -->
  <details open>
    <summary>Controls</summary>
    <div>
      <!-- For future if you want shuffle/reset; not wired now -->
      <!-- <button id="shuffle">Shuffle</button>
      <button id="reset">Reset</button> -->

      <!-- Remove player (put on stay for entire game) -->
      <input id="removeName" placeholder="Player name to remove" style="margin-right:8px;">
      <button id="removeBtn">Remove Player</button>
    </div>
  </details>

  <!-- Playing Table accordion -->
  <details open>
    <summary>Playing Table</summary>
    <div>
      <table class="playing-table">
        <colgroup>
          <col style="width: 45%;">
          <col style="width: 10%;">
          <col style="width: 45%;">
        </colgroup>
        <tbody>

          <!-- ROW 1 -->
          <tr>
            <!-- Seat 1 (order_index 0) -->
            <td id="alice-cell">
              <div class="player-name">Seat 1</div>
              <div class="card-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
              <div class="card-row second-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
            </td>

            <!-- Discard pile + End Round -->
            <td class="discard-cell">
              <button id="end-turns" class="end-turns-button" disabled>End Round</button>
              <div id="discard-pile" class="deck empty"></div>
              <div id="discard-count">Discarded: 0</div>
            </td>

            <!-- Seat 2 (order_index 1) -->
            <td id="bob-cell">
              <div class="player-name">Seat 2</div>
              <div class="card-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
              <div class="card-row second-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
            </td>
          </tr>

          <!-- ROW 2 -->
          <tr>
            <!-- Seat 3 (order_index 2) -->
            <td id="carol-cell">
              <div class="player-name">Seat 3</div>
              <div class="card-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
              <div class="card-row second-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
            </td>

            <!-- Deck -->
            <td class="deck-cell">
              <div>
                <div class="player-name deck-label">Deck</div>
                <div class="deck" id="deck"></div>
                <div id="deck-count">0 cards</div>
              </div>
            </td>

            <!-- Seat 4 (order_index 3) -->
            <td id="dave-cell">
              <div class="player-name">Seat 4</div>
              <div class="card-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
              <div class="card-row second-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
            </td>
          </tr>

          <!-- ROW 3 -->
          <tr>
            <!-- Seat 5 (order_index 4) -->
            <td id="eve-cell">
              <div class="player-name">Seat 5</div>
              <div class="card-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
              <div class="card-row second-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
            </td>

            <!-- Stay button -->
            <td class="stay-cell">
              <button id="stay-button" class="stay-button">ðŸª¬ Stay</button>
            </td>

            <!-- Seat 6 (order_index 5) -->
            <td id="frank-cell">
              <div class="player-name">Seat 6</div>
              <div class="card-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
              <div class="card-row second-row">
                <div class="card"></div><div class="card"></div><div class="card"></div>
                <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
              </div>
            </td>
          </tr>

        </tbody>
      </table>
    </div>

    <!-- Status message area -->
    <div id="status"></div>
  </details>

  <!-- Scoring accordion (simple placeholder) -->
  <details>
    <summary>Scoring</summary>
    <div>
      <p>Scores are tracked server-side per round and total. This section can be expanded later.</p>
    </div>
  </details>

  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Parse URL params
    const urlParams = new URLSearchParams(window.location.search);
    const playerId = parseInt(urlParams.get("playerId"), 10);
    const roomCode = window.location.pathname.split("/").pop().toUpperCase();

    const socket = io();

    // Seat order mapping: order_index 0..5 â†’ these cell IDs
    const seatIds = [
      "alice-cell",
      "bob-cell",
      "carol-cell",
      "dave-cell",
      "eve-cell",
      "frank-cell"
    ];

    const statusDiv = document.getElementById("status");
    const deckDiv = document.getElementById("deck");
    const discardPileDiv = document.getElementById("discard-pile");
    const discardCountDiv = document.getElementById("discard-count");
    const deckCountDiv = document.getElementById("deck-count");
    const stayButton = document.getElementById("stay-button");
    const endTurnsButton = document.getElementById("end-turns");
    const removeNameInput = document.getElementById("removeName");
    const removeBtn = document.getElementById("removeBtn");

    // value -> filename mapping from server
    let cardMeta = {}; // e.g. { "7": "7.png", "2x": "action-2x.png" }

    async function loadCardMeta() {
      try {
        const res = await fetch("/api/cards/meta");
        const data = await res.json();
        if (!data.success) return;

        data.cards.forEach(c => {
          cardMeta[c.value] = c.filename;
        });
      } catch (err) {
        console.error("Error loading card metadata", err);
      }
    }

    function getCardImgSrc(value) {
      const filename = cardMeta[value] || (value + ".png");
      return "cards/" + filename;
    }

    // Compute round score client-side (matches server logic)
    function computeRoundScore(values) {
      let score = 0;
      let mult = 1;

      for (const v of values) {
        const num = parseInt(v, 10);
        if (!isNaN(num)) {
          score += num;
          continue;
        }
        if (v === "2x") mult *= 2;
        if (v === "4+") score += 4;
        if (v === "5+") score += 5;
        if (v === "6-") score -= 6;
      }

      return score * mult;
    }

    function renderDeck(state) {
      deckDiv.innerHTML = "";

      const topCards = state.topDrawCards || [];
      const maxShow = Math.min(topCards.length, 5);

      for (let i = 0; i < maxShow; i++) {
        const value = topCards[i];
        const cardEl = document.createElement("div");
        cardEl.classList.add("card");

        const img = document.createElement("img");
        img.src = getCardImgSrc(value);
        cardEl.appendChild(img);

        cardEl.style.top = (i * 4) + "px";
        cardEl.style.left = (i * 4) + "px";

        deckDiv.appendChild(cardEl);
      }

      deckCountDiv.textContent = state.deckCount + " cards";
    }

    function renderDiscard(state) {
      discardPileDiv.classList.add("empty");
      discardPileDiv.innerHTML = ""; // For now just empty outline
      discardCountDiv.textContent = "Discarded: " + state.discardCount;
    }

    function renderPlayers(state) {
      // Build handsByPlayer: { playerId: [values...] }
      const handsByPlayer = {};
      state.hands.forEach(h => {
        if (!handsByPlayer[h.player_id]) handsByPlayer[h.player_id] = [];
        handsByPlayer[h.player_id].push(h.value);
      });

      // Clear all cells first
      seatIds.forEach(id => {
        const cell = document.getElementById(id);
        const nameDiv = cell.querySelector(".player-name");
        nameDiv.textContent = "Empty Seat";
        cell.classList.remove("active-player", "stayed-player");

        const slots = cell.querySelectorAll(".card-row .card");
        slots.forEach(slot => {
          slot.innerHTML = "";
        });
      });

      // Fill seats in order_index order
      state.players.forEach((p, index) => {
        if (index >= seatIds.length) return;
        const cellId = seatIds[index];
        const cell = document.getElementById(cellId);
        const nameDiv = cell.querySelector(".player-name");

        const handValues = handsByPlayer[p.id] || [];
        const roundScore = computeRoundScore(handValues);
        const totalScore = p.total_score || 0;

        nameDiv.textContent = `${p.name} â€” ${roundScore} / ${totalScore}`;

        cell.classList.remove("active-player", "stayed-player");
        if (p.stayed) cell.classList.add("stayed-player");
        if (state.currentPlayerId === p.id && !p.stayed && p.active && !state.roundOver) {
          cell.classList.add("active-player");
        }

        // Fill card slots with PNGs
        const slots = cell.querySelectorAll(".card-row .card");
        slots.forEach((slot, i) => {
          slot.innerHTML = "";
          if (i < handValues.length) {
            const v = handValues[i];
            const img = document.createElement("img");
            img.src = getCardImgSrc(v);
            slot.appendChild(img);
          }
        });
      });
    }

    function updateButtons(state) {
      const isMyTurn = state.currentPlayerId === playerId && !state.roundOver;
      const canDraw = isMyTurn && state.deckCount > 0;

      deckDiv.classList.toggle("disabled", !canDraw);
      stayButton.disabled = !isMyTurn;
      endTurnsButton.disabled = !state.roundOver;

      if (state.roundOver) {
        statusDiv.textContent = "Round over. Click End Round.";
      } else if (isMyTurn) {
        const me = state.players.find(p => p.id === playerId);
        statusDiv.textContent = `Your turn, ${me ? me.name : "Player"}.`;
      } else {
        const current = state.players.find(p => p.id === state.currentPlayerId);
        statusDiv.textContent = current
          ? `Current player: ${current.name}`
          : "Waiting for players...";
      }
    }

    socket.on("stateUpdate", (state) => {
      renderDeck(state);
      renderDiscard(state);
      renderPlayers(state);
      updateButtons(state);
    });

    // Join room once metadata loaded and socket connected
    socket.on("connect", async () => {
      await loadCardMeta();
      socket.emit("joinRoom", { roomCode, playerId });
    });

    // UI events
    deckDiv.addEventListener("click", () => {
      socket.emit("drawCard", { roomCode, playerId });
    });

    stayButton.addEventListener("click", () => {
      socket.emit("stay", { roomCode, playerId });
    });

    endTurnsButton.addEventListener("click", () => {
      socket.emit("endRound", { roomCode });
    });

    removeBtn.addEventListener("click", () => {
      const name = removeNameInput.value.trim();
      if (!name) return;
      socket.emit("removePlayer", { roomCode, name });
      removeNameInput.value = "";
    });

    statusDiv.textContent = "Connecting to room...";
  </script>

</body>
</html>
