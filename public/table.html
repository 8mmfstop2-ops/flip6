<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simplified Table</title>

  <style>
  /* ============================================================
     GLOBAL PAGE STYLING
  ============================================================ */
  body {
    font-family: Arial, sans-serif;
    background: #304730;
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 0;
  }

  #status {
    margin: 10px;
    font-weight: bold;
    color: #fff;
  }

  /* ============================================================
     ACCORDION SECTIONS
  ============================================================ */
  details {
    border: 1px solid #ccc;
    border-radius: 6px;
    margin: 6px auto;
    width: 95%;
    background: #222;
  }

  summary {
    cursor: pointer;
    padding: 5px 0;
    font-weight: 600;
    list-style: none;
  }

  summary::before {
    content: "â–¶";
    font-size: 0.9em;
    margin-right: 8px;
    transition: transform 0.2s ease;
    display: inline-block;
  }

  details[open] summary::before {
    transform: rotate(90deg);
  }

  details > div {
    padding: 6px;
    border-top: 1px solid #444;
    background: #333;
  }

  /* ============================================================
     TABLE LAYOUT (6 SEATS)
  ============================================================ */
  table.playing-table {
    margin: 5px auto;
    border-collapse: collapse;
    table-layout: fixed;
    width: 1400px;
  }

  .playing-table td {
    border: 2px solid #444;
    padding: 10px;
    vertical-align: top;
    background: #0a7f4f;
    border-radius: 8px;
  }

  .playing-table tr td:nth-child(2) {
    background: #7992BA;
    vertical-align: middle;
  }

  .playing-table tr:nth-child(3) td:nth-child(2) {
    vertical-align: top;
  }

  .player-name {
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 1.1em;
  }

  /* ============================================================
     CARD SLOTS
  ============================================================ */
  .card-row {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-bottom: 5px;
  }

  .card {
    width: 70px;
    height: 100px;
    background: transparent;
    border: none;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: default;
    user-select: none;
  }

  .card img {
    position: absolute;
    top: 0;
    left: 0;
    width: 70px;
    height: 100px;
    border: 3px solid #000;
    border-radius: 6px;
    z-index: 5;
  }

  /* ============================================================
     DECK AREA
  ============================================================ */
  .deck {
    position: relative;
    width: 80px;
    height: 110px;
    margin: 0 auto;
    user-select: none;
  }

  #deck {
    margin: 40px auto;
  }

  .deck .card {
    position: absolute;
    top: 0;
    left: 0;
    transition: all 0.3s ease;
    width: 70px;
    height: 100px;
    background: #fff;
    border: 2px solid #000;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .deck .card.top-card {
    background: url("/cards/back.png") center/cover no-repeat;
  }

  /* Deck thickness steps */
  .deck.step1 .card:nth-child(2) { top: 6px; left: 6px; }
  .deck.step1 .card:nth-child(3) { top: 12px; left: 8px; }
  .deck.step1 .card:nth-child(4) { top: 18px; left: 10px; }
  .deck.step1 .card:nth-child(5) { top: 24px; left: 14px; }

  .deck.step2 .card:nth-child(2) { top: 5px; left: 5px; }
  .deck.step2 .card:nth-child(3) { top: 10px; left: 10px; }
  .deck.step2 .card:nth-child(4) { top: 15px; left: 15px; }
  .deck.step2 .card:nth-child(5) { top: 20px; left: 20px; }

  .deck.step3 .card:nth-child(2) { top: 4px; left: -6px; }
  .deck.step3 .card:nth-child(3) { top: 8px; left: 2px; }
  .deck.step3 .card:nth-child(4) { top: 12px; left: 18px; }
  .deck.step3 .card:nth-child(5) { top: 16px; left: 12px; }

  .deck.step4 .card:nth-child(2) { top: 3px; left: -10px; }
  .deck.step4 .card:nth-child(3) { top: 6px; left: 0px; }
  .deck.step4 .card:nth-child(4) { top: 9px; left: 10px; }
  .deck.step4 .card:nth-child(5) { top: 12px; left: 18px; }

  .deck.step5 .card:nth-child(2) { top: 0; left: -1px; transform: rotate(-1deg); }
  .deck.step5 .card:nth-child(3) { top: 1px; left: 1px; transform: rotate(-1deg); }
  .deck.step5 .card:nth-child(4) { top: 2px; left: 5px; transform: rotate(-1deg); }
  .deck.step5 .card:nth-child(5) { top: 3px; left: 0; transform: rotate(0deg); }

  .deck.step6 .card:nth-child(3) { top: 2px; left: 2px; }
  .deck.step6 .card:nth-child(4) { top: 3px; left: 3px; }
  .deck.step6 .card:nth-child(5) { top: 4px; left: 4px; }

  .deck.step7 .card:nth-child(2) { top: 0; left: 0; }
  .deck.step7 .card:nth-child(3) { top: 1px; left: 1px; }
  .deck.step7 .card:nth-child(4) { top: 2px; left: 2px; }
  .deck.step7 .card:nth-child(5) { top: 3px; left: 3px; }

  .deck.step8 .card:nth-child(2) { top: 0; left: 0; }
  .deck.step8 .card:nth-child(3) { top: 0; left: 0; }
  .deck.step8 .card:nth-child(4) { top: 1px; left: 1px; }
  .deck.step8 .card:nth-child(5) { top: 2px; left: 2px; }

  .deck.step9 .card:nth-child(2),
  .deck.step9 .card:nth-child(3),
  .deck.step9 .card:nth-child(4),
  .deck.step9 .card:nth-child(5) {
    top: 0;
    left: 0;
  }

  .deck.step10 .card {
    display: none;
  }

  .deck.step10::before {
    content: "Empty";
    color: #fff;
    font-weight: bold;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 70px;
    height: 100px;
    border: 2px dashed #fff;
    border-radius: 6px;
    margin: auto;
  }

  #deck.placeholder::before {
    content: "Click to Start";
    display: flex;
    align-items: center;
    justify-content: center;
    width: 70px;
    height: 100px;
    border: 2px dashed #fff;
    border-radius: 6px;
    margin: auto;
    color: #fff;
    font-weight: bold;
  }

  /* ============================================================
     DISCARD PILE
  ============================================================ */
  td.discard-cell {
    text-align: center;
    vertical-align: top;
    padding: 10px 0;
  }

  #discard-pile.empty::before {
    content: "Empty";
    color: #fff;
    font-weight: bold;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 70px;
    height: 100px;
    border: 2px dashed #fff;
    border-radius: 6px;
    margin: auto;
  }

  /* ============================================================
     BUTTONS
  ============================================================ */
  .stay-button {
    background-color: #3f3f4f;
    color: #fff;
    font-size: 1.1em;
    font-weight: bold;
    padding: 18px 22px;
    border: none;
    border-radius: 8px;
    cursor: not-allowed;
    width: 100%;
    opacity: 0.5;
  }

  .end-turns-button {
    background-color: #6D1AA1;
    color: #fff;
    font-size: 1.1em;
    font-weight: bold;
    padding: 20px 8px;
    border: none;
    border-radius: 6px;
    cursor: not-allowed;
    margin-bottom: 8px;
    opacity: 0.5;
  }

  /* ============================================================
     AUDIO CONTROLS
  ============================================================ */
  .controls-audio {
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
  }

  .controls-audio label {
    font-size: 0.9em;
  }

  #volume-slider {
    accent-color: #1ff233;
    width: 150px;
    flex-shrink: 0;
  }

  #volume-percent {
    margin-left: 4px;
    color: #fff;
    opacity: 0.8;
    font-size: 0.9em;
  }

  /* ============================================================
     ROUND NUMBER
  ============================================================ */
  .round-number {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
    text-align: center;
    color: #fff;
  }

  /* ============================================================
     PAUSE OVERLAY (not used, but kept)
  ============================================================ */
  #pause-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(20, 20, 20, 0.85);
    color: #fff;
    font-size: 2em;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  </style>
</head>
<body>

<div id="pause-overlay">Game Paused</div>

<!-- ============================================================
     CONTROLS
============================================================ -->
<details open>
  <summary>Controls</summary>
  <div>
    <div class="controls-audio" style="gap:15px;">
      <button id="mute-toggle">Mute</button>

      <label>
        Volume:
        <input id="volume-slider" type="range" min="0" max="100" value="20">
        <span id="volume-percent">20%</span>
      </label>

      <button id="test-sounds-btn">Test Sounds</button>
    </div>
  </div>
</details>

<!-- ============================================================
     PLAYING TABLE
============================================================ -->
<details open>
  <summary>Playing Table</summary>

  <div id="status">Connectingâ€¦</div>

  <table class="playing-table">
    <colgroup>
      <col style="width:45%;">
      <col style="width:10%;">
      <col style="width:45%;">
    </colgroup>

    <tbody>
      <!-- Row 1 -->
      <tr>
        <td id="seat1">
          <div class="player-name">Seat 1</div>
          <div class="card-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
          <div class="card-row second-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
        </td>

        <td class="discard-cell">
          <div id="roundNumberDisplay" class="round-number">Round 1</div>
          <button id="end-turns" class="end-turns-button" disabled>End Round</button>

          <div id="discard-pile" class="deck empty"></div>
          <div id="discard-count">Discarded: 0</div>
        </td>

        <td id="seat2">
          <div class="player-name">Seat 2</div>
          <div class="card-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
          <div class="card-row second-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
        </td>
      </tr>

      <!-- Row 2 -->
      <tr>
        <td id="seat3">
          <div class="player-name">Seat 3</div>
          <div class="card-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
          <div class="card-row second-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
        </td>

        <td class="deck-cell">
          <div class="player-name deck-label">Deck</div>
          <div class="deck placeholder" id="deck"></div>
          <div id="deck-count">0 cards</div>
        </td>

        <td id="seat4">
          <div class="player-name">Seat 4</div>
          <div class="card-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
          <div class="card-row second-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
        </td>
      </tr>

      <!-- Row 3 -->
      <tr>
        <td id="seat5">
          <div class="player-name">Seat 5</div>
          <div class="card-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
          <div class="card-row second-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
        </td>

        <td class="stay-cell">
          <button id="pass-button" class="stay-button" disabled>âž¤ Pass</button>
          <button id="stay-button" class="stay-button" disabled>ðŸª¬ Stay</button>
        </td>

        <td id="seat6">
          <div class="player-name">Seat 6</div>
          <div class="card-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
          <div class="card-row second-row">
            <div class="card"></div><div class="card"></div><div class="card"></div>
            <div class="card"></div><div class="card"></div><div class="card"></div><div class="card"></div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</details>

<!-- ============================================================
     SOUND TEST POPUP
============================================================ -->
<div id="sound-popup"
     style="display:none; position:fixed; top:50%; left:50%;
            transform:translate(-50%, -50%); background:#222;
            padding:20px; border-radius:10px; z-index:99999;
            width:300px; text-align:left; border:2px solid #fff;">

  <h3 style="margin-top:0;">Test Sounds</h3>

  <ul id="sound-list" style="list-style:none; padding:0; margin:0;">
    <li class="sound-item" data-sound="shuffle" style="padding:6px; cursor:pointer;">shuffle.mp3</li>
    <li class="sound-item" data-sound="draw" style="padding:6px; cursor:pointer;">draw.mp3</li>
    <li class="sound-item" data-sound="bust" style="padding:6px; cursor:pointer;">bust.mp3</li>
  </ul>

  <button id="close-sound-popup"
          style="margin-top:15px; width:100%; padding:8px;">Close</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ============================================================
   URL PARAMS
============================================================ */
const urlParams = new URLSearchParams(window.location.search);
const playerId = parseInt(urlParams.get("playerId"), 10);
const roomCode = window.location.pathname.split("/").pop().toUpperCase();

/* ============================================================
   SOCKET CONNECTION
============================================================ */
const socket = io();

/* ============================================================
   DOM ELEMENTS
============================================================ */
const deckDiv = document.getElementById("deck");
const deckCountDiv = document.getElementById("deck-count");
const discardPileDiv = document.getElementById("discard-pile");
const discardCountDiv = document.getElementById("discard-count");
const statusDiv = document.getElementById("status");

/* ============================================================
   SOUND SYSTEM
============================================================ */
const sounds = {
  shuffle: new Audio("/sounds/shuffle.mp3"),
  draw: new Audio("/sounds/draw.mp3"),
  bust: new Audio("/sounds/bust.mp3")
};

let isMuted = false;
let volumeLevel = 0.4;

Object.values(sounds).forEach(s => {
  s.volume = volumeLevel;
  s.preload = "auto";
});

function playSound(name) {
  if (isMuted) return;
  const original = sounds[name];
  if (!original) return;
  const s = original.cloneNode();
  s.volume = volumeLevel;
  s.play().catch(() => {});
}

/* Volume slider */
const volumeSlider = document.getElementById("volume-slider");
const volumePercent = document.getElementById("volume-percent");

function updateVolume() {
  const val = parseInt(volumeSlider.value, 10);
  const clamped = Math.max(0, Math.min(100, val));
  volumeLevel = Math.pow(clamped / 100, 2);
  volumePercent.textContent = clamped + "%";
}

updateVolume();

volumeSlider.addEventListener("input", () => {
  updateVolume();
});

/* Mute toggle */
document.getElementById("mute-toggle").addEventListener("click", () => {
  isMuted = !isMuted;
  document.getElementById("mute-toggle").textContent = isMuted ? "Unmute" : "Mute";
});

/* Sound test popup */
document.getElementById("test-sounds-btn").addEventListener("click", () => {
  document.getElementById("sound-popup").style.display = "block";
});

document.getElementById("close-sound-popup").addEventListener("click", () => {
  document.getElementById("sound-popup").style.display = "none";
});

document.querySelectorAll(".sound-item").forEach(item => {
  item.addEventListener("click", () => {
    const soundName = item.dataset.sound;
    playSound(soundName);
  });
});

/* ============================================================
   MINIMAL STATE HANDLING
   Expected server state:
   { deckCount: number, discardCount: number }
============================================================ */
let lastDeckCount = 0;

function updateDeckVisual(deckCount) {
  deckDiv.innerHTML = "";

  if (deckCount === 0) {
    deckDiv.classList.add("placeholder");
    deckDiv.classList.remove("step1","step2","step3","step4","step5","step6","step7","step8","step9","step10");
    deckDiv.classList.add("step10");
    deckCountDiv.textContent = "0 cards";
    return;
  }

  deckDiv.classList.remove("placeholder");
  const count = Math.min(deckCount, 5);

  for (let i = 0; i < count; i++) {
    const card = document.createElement("div");
    card.classList.add("card");
    if (i === count - 1) {
      card.classList.add("top-card");
    }
    deckDiv.appendChild(card);
  }

  // Simple step logic based on percentage
  const percent = deckCount; // if you want, you can normalize by max size
  let step = 1;
  if (percent > 40) step = 1;
  else if (percent > 30) step = 2;
  else if (percent > 20) step = 3;
  else if (percent > 10) step = 4;
  else if (percent > 5) step = 5;
  else if (percent > 4) step = 6;
  else if (percent > 3) step = 7;
  else if (percent > 2) step = 8;
  else if (percent > 1) step = 9;
  else step = 10;

  deckDiv.className = "deck step" + step;
  deckCountDiv.textContent = deckCount + " cards";
}

socket.on("stateUpdate", (state) => {
  const deckCount = state.deckCount ?? 0;
  const discardCount = state.discardCount ?? 0;

  // Shuffle sound when deck appears
  if (lastDeckCount === 0 && deckCount > 0) {
    playSound("shuffle");
  }
  lastDeckCount = deckCount;

  updateDeckVisual(deckCount);

  discardCountDiv.textContent = "Discarded: " + discardCount;

  statusDiv.textContent = "Connected to room " + roomCode;
});

/* ============================================================
   ON CONNECT â†’ JOIN ROOM
============================================================ */
socket.on("connect", () => {
  socket.emit("joinRoom", { roomCode, playerId });
  statusDiv.textContent = "Joining room " + roomCode + "â€¦";
});
</script>

</body>
</html>
